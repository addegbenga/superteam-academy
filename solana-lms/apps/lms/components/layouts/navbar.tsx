"use client";
import { Trophy, User, Zap, Menu, Wallet } from "lucide-react";
import { useState } from "react";
import Link from "next/link";
import { Button } from "@workspace/ui/components/button";
import {
  Sheet,
  SheetContent,
  SheetTrigger,
} from "@workspace/ui/components/sheet";
import { useQuery } from "@tanstack/react-query";
import { userQueries } from "@/lib/queries";
import { getCurrentUserId } from "@/hooks/auth";
import { StreakPopover } from "../streak";
import { usePathname } from "next/navigation";
import { cn } from "@workspace/ui/lib/utils";

export function Navbar() {
  const pathname = usePathname();
  const userId = getCurrentUserId();
  const { data: user } = useQuery(userQueries.profile(userId));
  const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);

  const navItems = [
    { label: "Courses", href: "/course" },
    { label: "Leaderboard", href: "/leaderboard" },
    { label: "Profile", href: "/profile" },
  ];

  const isActive = (href: string) => {
    // Handles nested routes like /course/123
    return pathname === href || pathname.startsWith(`${href}/`);
  };

  return (
    <header className="sticky top-0 w-full z-50 border-b border-white/5 bg-background/60 backdrop-blur-xl">
      <div className="px-4 h-20 flex items-center justify-between">
        <div className="flex gap-20 items-center">
          <Link
            className="flex -mt-2 items-center gap-2 group cursor-pointer"
            href="/"
          >
            <svg
              width="100"
              height="100"
              viewBox="0 0 43 11"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <rect
                y="2"
                width="8"
                height="8"
                rx="1"
                fill="white"
                fillOpacity="0.95"
              />
              <rect
                x="4.91422"
                y="3.3786"
                width="1"
                height="5"
                rx="0.5"
                transform="rotate(45 4.91422 3.3786)"
                fill="black"
              />
              <rect
                x="8.92242"
                y="1.61311"
                width="1"
                height="8.37557"
                rx="0.5"
                transform="rotate(45 8.92242 1.61311)"
                fill="black"
              />
              <path
                d="M12.838 10.0935C12.321 10.0935 11.8755 10.0183 11.5015 9.868C11.1312 9.71767 10.8433 9.49033 10.638 9.186C10.4327 8.878 10.319 8.4875 10.297 8.0145H11.9635C11.9965 8.30783 12.09 8.52417 12.244 8.6635C12.4017 8.80283 12.6125 8.8725 12.8765 8.8725C13.0085 8.8725 13.135 8.85783 13.256 8.8285C13.377 8.7955 13.476 8.7405 13.553 8.6635C13.63 8.58283 13.6685 8.47283 13.6685 8.3335C13.6685 8.21983 13.6392 8.12817 13.5805 8.0585C13.5255 7.98517 13.443 7.92467 13.333 7.877C13.2267 7.82567 13.0965 7.77983 12.9425 7.7395C12.7885 7.6955 12.6143 7.64417 12.42 7.5855C12.0753 7.48283 11.7527 7.35817 11.452 7.2115C11.155 7.06483 10.9148 6.86867 10.7315 6.623C10.5482 6.37733 10.4565 6.05467 10.4565 5.655C10.4565 5.05733 10.6747 4.61367 11.111 4.324C11.551 4.03433 12.1267 3.8895 12.838 3.8895C13.256 3.8895 13.6318 3.94633 13.9655 4.06C14.2992 4.17367 14.5742 4.37533 14.7905 4.665C15.0105 4.95467 15.1517 5.3635 15.214 5.8915L13.5585 5.8805C13.5255 5.64583 13.4687 5.47167 13.388 5.358C13.3073 5.24067 13.2157 5.16367 13.113 5.127C13.0103 5.08667 12.904 5.0665 12.794 5.0665C12.6693 5.0665 12.5557 5.08667 12.453 5.127C12.354 5.16733 12.2752 5.226 12.2165 5.303C12.1578 5.38 12.1285 5.47717 12.1285 5.5945C12.1285 5.73383 12.1725 5.853 12.2605 5.952C12.3485 6.051 12.4823 6.139 12.662 6.216C12.8417 6.28933 13.0708 6.3645 13.3495 6.4415C13.5328 6.48917 13.7382 6.54783 13.9655 6.6175C14.1965 6.68717 14.4165 6.78433 14.6255 6.909C14.8382 7.03367 15.0123 7.20233 15.148 7.415C15.2873 7.62767 15.357 7.90267 15.357 8.24C15.357 8.82667 15.1315 9.28317 14.6805 9.6095C14.2295 9.93217 13.6153 10.0935 12.838 10.0935ZM18.5091 10.0825C17.9261 10.0825 17.4201 9.96333 16.9911 9.725C16.5621 9.48667 16.2284 9.1365 15.9901 8.6745C15.7554 8.20883 15.6381 7.63867 15.6381 6.964C15.6381 6.326 15.7628 5.776 16.0121 5.314C16.2614 4.852 16.6043 4.49817 17.0406 4.2525C17.4769 4.00317 17.9738 3.8785 18.5311 3.8785C19.1324 3.8785 19.6458 4.00317 20.0711 4.2525C20.5001 4.49817 20.8283 4.852 21.0556 5.314C21.2866 5.776 21.4021 6.326 21.4021 6.964C21.4021 7.63867 21.2756 8.20883 21.0226 8.6745C20.7696 9.1365 20.4249 9.48667 19.9886 9.725C19.5523 9.96333 19.0591 10.0825 18.5091 10.0825ZM18.5311 8.669C18.8648 8.669 19.1434 8.54617 19.3671 8.3005C19.5908 8.05117 19.7026 7.60567 19.7026 6.964C19.7026 6.36633 19.5853 5.93917 19.3506 5.6825C19.1196 5.42217 18.8409 5.292 18.5146 5.292C18.1809 5.292 17.9023 5.42217 17.6786 5.6825C17.4549 5.93917 17.3431 6.36633 17.3431 6.964C17.3431 7.58 17.4604 8.01817 17.6951 8.2785C17.9298 8.53883 18.2084 8.669 18.5311 8.669ZM22.0441 10V1.409H23.7601V10H22.0441ZM24.7351 10V3.9995H26.2641L26.4071 6.348L26.3081 5.9905C26.3411 5.67517 26.4016 5.38917 26.4896 5.1325C26.5776 4.87217 26.6913 4.6485 26.8306 4.4615C26.9699 4.2745 27.1368 4.12967 27.3311 4.027C27.5291 3.92433 27.7546 3.873 28.0076 3.873C28.0809 3.873 28.1543 3.87667 28.2276 3.884C28.3046 3.89133 28.3724 3.90417 28.4311 3.9225V5.699C28.3064 5.666 28.1854 5.644 28.0681 5.633C27.9544 5.61833 27.8408 5.611 27.7271 5.611C27.5254 5.611 27.3421 5.62933 27.1771 5.666C27.0158 5.70267 26.8746 5.7595 26.7536 5.8365C26.6326 5.90983 26.5318 6.00517 26.4511 6.1225V10H24.7351ZM28.8011 10V3.9995H30.5061V10H28.8011ZM29.6591 3.312C29.3731 3.312 29.1292 3.213 28.9276 3.015C28.7259 2.81333 28.6251 2.55667 28.6251 2.245C28.6251 1.93333 28.7259 1.68033 28.9276 1.486C29.1292 1.288 29.3731 1.189 29.6591 1.189C29.9414 1.189 30.1834 1.288 30.3851 1.486C30.5867 1.68033 30.6876 1.93333 30.6876 2.245C30.6876 2.55667 30.5867 2.81333 30.3851 3.015C30.1834 3.213 29.9414 3.312 29.6591 3.312ZM33.6155 10.0935C33.0985 10.0935 32.653 10.0183 32.279 9.868C31.9087 9.71767 31.6209 9.49033 31.4155 9.186C31.2102 8.878 31.0965 8.4875 31.0745 8.0145H32.741C32.774 8.30783 32.8675 8.52417 33.0215 8.6635C33.1792 8.80283 33.39 8.8725 33.654 8.8725C33.786 8.8725 33.9125 8.85783 34.0335 8.8285C34.1545 8.7955 34.2535 8.7405 34.3305 8.6635C34.4075 8.58283 34.446 8.47283 34.446 8.3335C34.446 8.21983 34.4167 8.12817 34.358 8.0585C34.303 7.98517 34.2205 7.92467 34.1105 7.877C34.0042 7.82567 33.874 7.77983 33.72 7.7395C33.566 7.6955 33.3919 7.64417 33.1975 7.5855C32.8529 7.48283 32.5302 7.35817 32.2295 7.2115C31.9325 7.06483 31.6924 6.86867 31.509 6.623C31.3257 6.37733 31.234 6.05467 31.234 5.655C31.234 5.05733 31.4522 4.61367 31.8885 4.324C32.3285 4.03433 32.9042 3.8895 33.6155 3.8895C34.0335 3.8895 34.4094 3.94633 34.743 4.06C35.0767 4.17367 35.3517 4.37533 35.568 4.665C35.788 4.95467 35.9292 5.3635 35.9915 5.8915L34.336 5.8805C34.303 5.64583 34.2462 5.47167 34.1655 5.358C34.0849 5.24067 33.9932 5.16367 33.8905 5.127C33.7879 5.08667 33.6815 5.0665 33.5715 5.0665C33.4469 5.0665 33.3332 5.08667 33.2305 5.127C33.1315 5.16733 33.0527 5.226 32.994 5.303C32.9354 5.38 32.906 5.47717 32.906 5.5945C32.906 5.73383 32.95 5.853 33.038 5.952C33.126 6.051 33.2599 6.139 33.4395 6.216C33.6192 6.28933 33.8484 6.3645 34.127 6.4415C34.3104 6.48917 34.5157 6.54783 34.743 6.6175C34.974 6.68717 35.194 6.78433 35.403 6.909C35.6157 7.03367 35.7899 7.20233 35.9255 7.415C36.0649 7.62767 36.1345 7.90267 36.1345 8.24C36.1345 8.82667 35.909 9.28317 35.458 9.6095C35.007 9.93217 34.3929 10.0935 33.6155 10.0935ZM39.2481 10.0825C38.6395 10.0825 38.1206 9.9615 37.6916 9.7195C37.2626 9.4775 36.9345 9.12733 36.7071 8.669C36.4798 8.207 36.3661 7.64967 36.3661 6.997C36.3661 6.32233 36.4871 5.754 36.7291 5.292C36.9711 4.82633 37.3121 4.47433 37.7521 4.236C38.1921 3.99767 38.7073 3.8785 39.2976 3.8785C39.8696 3.8785 40.35 3.98667 40.7386 4.203C41.131 4.41933 41.428 4.73833 41.6296 5.16C41.8313 5.58167 41.9321 6.1005 41.9321 6.7165C41.9321 6.7935 41.9285 6.88333 41.9211 6.986C41.9175 7.085 41.912 7.19867 41.9046 7.327H38.0436C38.084 7.82567 38.205 8.1905 38.4066 8.4215C38.6083 8.64883 38.8906 8.7625 39.2536 8.7625C39.5543 8.7625 39.7816 8.6965 39.9356 8.5645C40.0933 8.4325 40.1868 8.25833 40.2161 8.042H41.8551C41.8221 8.45633 41.6956 8.8175 41.4756 9.1255C41.2593 9.42983 40.9623 9.66633 40.5846 9.835C40.207 10 39.7615 10.0825 39.2481 10.0825ZM38.7421 6.3645H40.2876C40.273 5.9795 40.1795 5.69167 40.0071 5.501C39.8385 5.31033 39.5781 5.215 39.2261 5.215C38.8118 5.215 38.5093 5.3635 38.3186 5.6605C38.128 5.95383 38.0308 6.37183 38.0271 6.9145C38.0565 6.7055 38.128 6.5625 38.2416 6.4855C38.3553 6.40483 38.5221 6.3645 38.7421 6.3645Z"
                fill="white"
                fillOpacity="0.95"
              />
            </svg>
          </Link>

          {/* Desktop Nav */}
          <nav className="hidden md:flex items-center gap-8">
            {navItems.map((item) => {
              const active = isActive(item.href);
              return (
                <Link
                  className={cn(
                    "text-muted-foreground text-sm",

                    active
                      ? " text-foreground font-medium"
                      : "text-muted-foreground hover:text-white",
                  )}
                  key={item.href}
                  href={item.href}
                >
                  {item.label}
                </Link>
              );
            })}
          </nav>
        </div>

        <div className="hidden md:flex items-center gap-4">
          <StreakPopover
            xp={user?.xp ?? 0}
            streak={user?.streak.current ?? 0}
          />

          <Link
            className="w-9 h-9 rounded-full bg-white/10 flex items-center justify-center hover:bg-white/20 transition-colors"
            href="/dashboard"
          >
            <User className="w-4 h-4" />
          </Link>
        </div>

        {/* Mobile Menu */}
        <Sheet open={isMobileMenuOpen} onOpenChange={setIsMobileMenuOpen}>
          <SheetTrigger asChild>
            <Button variant="ghost" size="icon" className="md:hidden">
              <Menu className="w-5 h-5" />
            </Button>
          </SheetTrigger>
          <SheetContent
            side="right"
            className="border-l border-white/10 bg-black/95 backdrop-blur-xl"
          >
            <div className="flex flex-col gap-8 mt-8">
              <nav className="flex flex-col gap-4">
                {navItems.map((item) => (
                  <Link
                    key={item.href}
                    href={item.href}
                    onClick={() => setIsMobileMenuOpen(false)}
                    className="text-lg font-medium hover:text-primary transition-colors"
                  >
                    {item.label}
                  </Link>
                ))}
              </nav>

              <div className="flex items-center gap-3 px-3 py-2 rounded-full border border-white/5 bg-white/5">
                <div className="flex items-center gap-1.5 text-xs font-mono text-primary">
                  <Zap className="w-3.5 h-3.5 fill-primary" />
                  <span>{user?.xp ?? 0} XP</span>
                </div>
                <div className="w-px h-3 bg-white/10" />
                <div className="flex items-center gap-1.5 text-xs font-mono text-orange-400">
                  <Trophy className="w-3.5 h-3.5" />
                  <span>{user?.streak.current ?? 0} Day Streak</span>
                </div>
              </div>

              <div className="flex flex-col gap-4">
                <Button className="w-full gap-2 bg-linear-to-r from-primary to-secondary text-black font-bold">
                  <Wallet className="w-4 h-4" />
                  Connect Wallet
                </Button>
              </div>
            </div>
          </SheetContent>
        </Sheet>
      </div>
    </header>
  );
}
